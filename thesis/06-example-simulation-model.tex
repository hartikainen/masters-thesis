\chapter{Example Model of Packet Processing System}
\label{chapter:example-simulation-model}

In this chapter, we present an example simulation model of Cavium OCTEON II network processing unit \cite{Cavium OCTEON}.

\todo[inline]{We will first demonstrate the measurement hardware and the setup needed to obtain the reference values for the simulation model. Two different measurements will be done, one to measure the communication latencies and another to measure the memory latencies. After that, we will plug in the reference values to the model and describe the relevant details of it.}

\section{Simulation Model}
\label{sec:simulation-model}



\section{Reference Values}
\label{sec:reference-values}

% For our approach to be valid, i.e. the abstraction of the communication latencies to be precise enough, we have to assume the fastpath is not the bottleneck in the processing phase. This assumption is reasonable because ...

% \fixme{
%   TODO:
%   \begin{itemize}
%   \item because the fastpath hardware is optimized for this task
%   \item find reference
%   \item maybe justify the stuff with some kind of rough back-of-the-envelope calculation?
%   \end{itemize}
% }

\subsection{Cavium OCTEON II}


\subsection{Communication Latencies}

We measured the communication latencies of the example fastpath by generating traffic from external machine, and sending it through two OCTEON II blades back to the generator. We did the measurements at two independent points in the processing path, to validate the accuracy of the measurements.

\begin{figure}[ht]
  \begin{center}
    \input{images/comm-setup.tex}
    \caption{The setup used to measure the communication latencies. The measurement points shown with the probes.}
    \label{fig:comm-setup}
  \end{center}
\end{figure}
\todo[inline]{Make this figure clearer, Emphasize the input and output parts of the flow.}

In figure~\ref{fig:comm-setup}, the rectangles represent three different computing units (traffic generator, forward blade, and swap blade), and the probes present the points of time measurements. The traffic generator used is a typical desktop computer running Linux and the traffic was generated by Mausezahn \ref{MAUSEZAHN}. Both of the OCTEON II blades are running Linux.

The packet is first generated at the packet generator and sent to the forward blade at time $t_{d0}$. Forwarding blade receives the packet, does the needed processing and forwards the packet to the swap blade at time $t_{d1}$. The swap blade receives the packet at time $t_{r2}$, does the same processing as the forward blade (except with different destination address), and forwards the packet back to the forward blade at time $t_{d2}$. Finally the forward blade receives the packet at time $t_{r1}$ and forwards it to the traffic generator, which marks it received at time $t_{r0}$. The time $t_{f}$ spent in the fastpath (input and output) phase of one blade is then

\begin{equation}
  \label{eq:1}
  t_{f} = \frac{t_{r1} - t_{d1} - (t_{d2} - t_{r2})}{2}
\end{equation}

We measured the times for packet sizes of 64B, 128B, 256B, 512B, 1024B, and 1500B, repeating the measurement for each packet 10000 times. Figure~\ref{fig:comm-latency} shows the resulting times $t_{f}$ for the different packet sizes.

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/comm-latency.pdf}
    \caption{Latency of the fastpath (input and output) phase of the OCTEON II board. Averages shown marked as red x, and the 99\% confidence intervals with +. The trendline is of equation.}
    \label{fig:comm-latency}
  \end{center}
\end{figure}
\todo[inline]{check the confint}
\todo[inline]{latency = a*packetsize + constant}

As figure ~\ref{fig:comm-latency} shows us, the time spent in the input and output phase of the board is linear regarding to the packet size. The variation of the data is relatively small, and all the measurements correspond to the values measured with the external traffic-generator.

\todo[inline]{the following needs to be explained somewhere with the other fastpath stuff.}
\todo[inline]{Regardless of the packet size, the size of the work queue entry handled by the input/output units is the same.}
\todo[inline]{Also, the forward/swap code is constant in terms of packet size.}
\todo[inline]{Only operation that is dependent on the packet size is the copy from input to L2/RAM and from L2/RAM to output unit.}

As explained earlier \todo{actually explain this}, the only packet size dependent operations in the fastpath are the  memory transfers between the memory (L2/RAM) and PKI or PKO.

\subsection{Memory Delays}

Memory delays were measured using Multi-core Processor Architecture and Communication (MPAC) benchmarking library. \ref{referenssi} Both, latency and throughput, were measured using for different dataset sizes and number of threads.

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/mem-latency.pdf}
    \caption{Memory latencies of the example NPU, measure by MPAC.}
    \label{fig:mem-latency}
  \end{center}
\end{figure}

\todo[inline]{logarithmic Y-scale}
\todo[inline]{explain the figure}

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=\textwidth]{images/mem-throughput.pdf}
    \caption{Memory throughput of the example NPU, measure by MPAC.}
    \label{fig:mem-throughput}
  \end{center}
\end{figure}

\todo[inline]{explain the figure}

\section{Workload Model}
\todo[inline]{ workload }


\section{Hardware Model}
\todo[inline]{ Scheduler, input/output, NPU nodes }


\section{Software Model}
\todo[inline]{ Scheduler, OpenEM-type application model }

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis-hartikainen"
%%% End:
